<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
	<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>

Python Context Managers • sangeeta.io

</title>
<meta name="description" content=" Sangeeta's personal coding blog.">
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/feed.xml">

<!-- icons -->
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
<meta name="theme-color" content="#ff95d0">
<meta name="msapplication-TileColor" content="#ff95d0">
<meta name="msapplication-TileImage" content="/mstile-150x150.png">
<!-- /icons -->

<!-- og tags -->
<meta property="og:site_name" content="sangeeta.io">
<meta property="og:title" content="Python Context Managers • sangeeta.io">
<meta property="og:locale" content="en">

  
    <meta property="og:image" content="https://sangeeta.io/images/og-image.jpg">
  

<meta property="og:type" content="website">
<meta property="og:url" content="https://sangeeta.io/posts/python-context-managers/">
<meta property="og:description" content="

Sangeeta's personal coding blog.
">
<!-- /og tags -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="/js/modernizr.js"></script>
<script src="/js/fitvids.js"></script>
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:400,700|Source+Sans+Pro:600,900|Crimson+Text:700italic,600,600italic,400,700,400italic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/css/reset.css">
<link rel="stylesheet" href="/css/pygments.css">
<link href="/css/syntax.css" rel="stylesheet" >

<link rel="stylesheet" href="/css/font-awesome.css">

<link rel="stylesheet" href="/css/style.css">
<!--[if gte IE 9]>
  <style type="text/css">
    .gradient {
       filter: none;
    }
  </style>
<![endif]-->


  







<!-- Don't show the dot before first article on home page -->

<style>
header {
  margin-bottom: 40px;
}
@media all and (min-width: 500px) {
  header {
    margin-bottom: 100px;
  }
}
header::after {
  display: none;
}
</style>

<!-- -->


<style>
header {
  margin-bottom: 40px;
}
@media all and (min-width: 500px) {
  header {
    margin-bottom: 100px;
  }
}
header::after {
  display: none;
}
</style>




</head>
<body>
	
	<div class="wrap">
		<header>
  <a href="/" class="website-title">

    
    sangeeta.io

  </a>
  <nav>
  <a href="/about/">About</a>
  <a href="/blog/">Blog</a>
  <a href="/contact/">Contact</a>
  <a href="/archive/">Archive</a>
</nav>

</header>

		


<article>
  <span class="meta">Mar 2, 2018 • 18&nbsp;min read</span>
  <h1>Python Context Managers</h1>
  <span class="tag-container">
    
        
        <a href="/tag/python" class="post-tag"><nobr>python</nobr>&nbsp;</a>
    
  </span>
  <p>In this article, we discuss what context managers are and how you can use them in different ways. There’s a lot of examples we build on to demonstrate different scenarios, and by the time you’re done reading this you will definitely be comfortable using context managers and implementing them in your code!</p>

<p>Let’s just jump right in, shall we?</p>

<p>If you’ve ever opened a file in Python, you probably did something like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'foo.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Hello, World!'</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>This approach assumes that the we can write to the file without any hiccups, but if an exception does occur during writing, the <code class="language-plaintext highlighter-rouge">f.close()</code> statement will never get executed! Also, we have the burden of having to explicitly close the file, and there is a chance we can forgot to do that if our code is complicated. In either case, we can leak a file descriptor in our program if the file never gets closed…oopsie!</p>

<p>To handle any possible exceptions, we can stick our code in a <code class="language-plaintext highlighter-rouge">try...except...finally</code> block, ensuring that we close the file in the <code class="language-plaintext highlighter-rouge">finally</code> block:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'foo.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Hello, World!'</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span></code></pre></figure>

<p>This is great! Our code handles exceptions, and we are guaranteed that the file will be closed no matter if an exception is thrown.</p>

<hr />
<p>Let’s take a step back for a moment – resource management (setting up and cleaning up a resource) is a common programming pattern. In our example, cleaning up the resource means closing the file. If we are connecting to a database, we might use this same pattern to ensure that the database connection is closed after we’re done using it. Like many things in programming, patterns can and should be <em>abstracted away</em>. We see this in the next example.</p>

<hr />
<p>So even though our previous code works, we can trim it down even further using the <code class="language-plaintext highlighter-rouge">with</code> statement, like this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'foo.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Hello, World!'</span><span class="p">)</span></code></pre></figure>

<p>But where did our <code class="language-plaintext highlighter-rouge">f.close()</code> statement go? Well, with the magic of the <code class="language-plaintext highlighter-rouge">with</code> statement and these things called context managers, our file <em>is</em> being closed but the code that executes the close statement is abtracted away from us.</p>

<h3 id="what-are-context-managers">What are context managers?</h3>
<p>Context managers are simply a protocol that an object needs to follow in order for it to be used with the <code class="language-plaintext highlighter-rouge">with</code> statement. That “protocol” means that the object needs to define two methods: an <code class="language-plaintext highlighter-rouge">__enter__()</code> and an <code class="language-plaintext highlighter-rouge">__exit__()</code>. Python docs <a href="https://docs.python.org/3/reference/datamodel.html#with-statement-context-managers" target="_blank">here</a>.</p>

<p>When we use the <code class="language-plaintext highlighter-rouge">with</code> statement, we must call a class or a function that returns a context manager object.</p>

<p>Let’s go back to our file example. Python’s <code class="language-plaintext highlighter-rouge">open</code> function returns a context manager, which is then assigned to the variable <code class="language-plaintext highlighter-rouge">f</code>. If we do a simple print statement, we can see what our context manager is:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'foo.txt'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>  <span class="c1"># &lt;class '_io.TextIOWrapper'&gt;</span></code></pre></figure>

<p>This means that the <code class="language-plaintext highlighter-rouge">_io.TextIOWrapper</code> class must have <code class="language-plaintext highlighter-rouge">__enter__</code> and <code class="language-plaintext highlighter-rouge">__exit__</code> methods defined somewhere on its source code. To prove this, let’s inspect the <code class="language-plaintext highlighter-rouge">_io.TextIOWrapper</code> class with the <code class="language-plaintext highlighter-rouge">dir</code> method to see its attributes and methods:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">_io</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">dir</span><span class="p">(</span><span class="n">_io</span><span class="p">.</span><span class="n">TextIOWrapper</span><span class="p">)</span>
<span class="p">[</span><span class="s">'_CHUNK_SIZE'</span><span class="p">,</span> <span class="s">'__class__'</span><span class="p">,</span> <span class="s">'__del__'</span><span class="p">,</span> <span class="s">'__delattr__'</span><span class="p">,</span> <span class="s">'__dict__'</span><span class="p">,</span> <span class="s">'__dir__'</span><span class="p">,</span> <span class="s">'__doc__'</span><span class="p">,</span> <span class="s">'__enter__'</span><span class="p">,</span> <span class="s">'__eq__'</span><span class="p">,</span> <span class="s">'__exit__'</span><span class="p">,</span> <span class="s">'__format__'</span><span class="p">,</span> <span class="s">'__ge__'</span><span class="p">,</span> <span class="s">'__getattribute__'</span><span class="p">,</span> <span class="s">'__getstate__'</span><span class="p">,</span> <span class="s">'__gt__'</span><span class="p">,</span> <span class="s">'__hash__'</span><span class="p">,</span> <span class="s">'__init__'</span><span class="p">,</span> <span class="s">'__init_subclass__'</span><span class="p">,</span> <span class="s">'__iter__'</span><span class="p">,</span> <span class="s">'__le__'</span><span class="p">,</span> <span class="s">'__lt__'</span><span class="p">,</span> <span class="s">'__ne__'</span><span class="p">,</span> <span class="s">'__new__'</span><span class="p">,</span> <span class="s">'__next__'</span><span class="p">,</span> <span class="s">'__reduce__'</span><span class="p">,</span> <span class="s">'__reduce_ex__'</span><span class="p">,</span> <span class="s">'__repr__'</span><span class="p">,</span> <span class="s">'__setattr__'</span><span class="p">,</span> <span class="s">'__sizeof__'</span><span class="p">,</span> <span class="s">'__str__'</span><span class="p">,</span> <span class="s">'__subclasshook__'</span><span class="p">,</span> <span class="s">'_checkClosed'</span><span class="p">,</span> <span class="s">'_checkReadable'</span><span class="p">,</span> <span class="s">'_checkSeekable'</span><span class="p">,</span> <span class="s">'_checkWritable'</span><span class="p">,</span> <span class="s">'_finalizing'</span><span class="p">,</span> <span class="s">'buffer'</span><span class="p">,</span> <span class="s">'close'</span><span class="p">,</span> <span class="s">'closed'</span><span class="p">,</span> <span class="s">'detach'</span><span class="p">,</span> <span class="s">'encoding'</span><span class="p">,</span> <span class="s">'errors'</span><span class="p">,</span> <span class="s">'fileno'</span><span class="p">,</span> <span class="s">'flush'</span><span class="p">,</span> <span class="s">'isatty'</span><span class="p">,</span> <span class="s">'line_buffering'</span><span class="p">,</span> <span class="s">'name'</span><span class="p">,</span> <span class="s">'newlines'</span><span class="p">,</span> <span class="s">'read'</span><span class="p">,</span> <span class="s">'readable'</span><span class="p">,</span> <span class="s">'readline'</span><span class="p">,</span> <span class="s">'readlines'</span><span class="p">,</span> <span class="s">'seek'</span><span class="p">,</span> <span class="s">'seekable'</span><span class="p">,</span> <span class="s">'tell'</span><span class="p">,</span> <span class="s">'truncate'</span><span class="p">,</span> <span class="s">'writable'</span><span class="p">,</span> <span class="s">'write'</span><span class="p">,</span> <span class="s">'writelines'</span><span class="p">]</span></code></pre></figure>

<p>And in fact we do see our two special methods! 🎉 (<em>scroll right</em>)</p>

<hr />
<p><em>Fun Fact</em>: If you want to dig into Python’s <code class="language-plaintext highlighter-rouge">open</code> function implementation, check it out <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L37" target="_blank">here</a> in the <code class="language-plaintext highlighter-rouge">io</code> module implentation inside the python/cpython repository on GitHub. It is worth noting that the <code class="language-plaintext highlighter-rouge">_io</code> module provides the C code that the <code class="language-plaintext highlighter-rouge">io</code> module uses internally, so the <code class="language-plaintext highlighter-rouge">io</code> module references the <code class="language-plaintext highlighter-rouge">_io</code> module.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">_io</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">_io</span><span class="p">.</span><span class="n">TextIOWrapper</span><span class="p">))</span>  <span class="c1"># &lt;class '_io.TextIOWrapper'&gt;
</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">TextIOWrapper</span><span class="p">))</span>  <span class="c1"># &lt;class '_io.TextIOWrapper'&gt;</span></code></pre></figure>

<p>In the <code class="language-plaintext highlighter-rouge">open</code> method docstring, it says that the method <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L149" target="_blank">returns a TextIOWrapper</a>. You’ll see that the <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L1910" target="_blank"><code class="language-plaintext highlighter-rouge">TextIOWrapper</code> class</a> does not actually define the <code class="language-plaintext highlighter-rouge">__enter__</code> and <code class="language-plaintext highlighter-rouge">__exit__</code> methods on itself but inherits them from the <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L1757" target="_blank"><code class="language-plaintext highlighter-rouge">TextIOBase</code> class</a> which inherits them from the <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L281" target="_blank"><code class="language-plaintext highlighter-rouge">IOBase</code> abstract base class</a>.</p>

<p>In fact, to answer our earlier question of where did our <code class="language-plaintext highlighter-rouge">f.close()</code> statement go, here is where it is called in the <code class="language-plaintext highlighter-rouge">IOBase</code> class.</p>

<p><img src="/images/IOBase_context_managers.png" alt="IOBase-context-manager" class="img-dropshadow" /> <small>Source: <a href="https://github.com/python/cpython/blob/master/Lib/_pyio.py#L447">github.com</a></small></p>

<hr />

<h3 id="more-about-__enter__-and-__exit__">More about <code class="language-plaintext highlighter-rouge">__enter__</code> and <code class="language-plaintext highlighter-rouge">__exit__</code></h3>

<p>The <code class="language-plaintext highlighter-rouge">__enter__</code> method in a context manager returns the resource (for example, a file object) or returns <code class="language-plaintext highlighter-rouge">self</code>, and the <code class="language-plaintext highlighter-rouge">__exit__</code> method does any cleaning up (for example, closing a file, handling exceptions). Of course the class itself can have its <code class="language-plaintext highlighter-rouge">__init__</code> method to set up stuff as well as other class methods.</p>

<p>Some important things to understand here is that when we use the <code class="language-plaintext highlighter-rouge">with</code> statement, any code inside the <code class="language-plaintext highlighter-rouge">with</code> statement block is executed after the <code class="language-plaintext highlighter-rouge">__enter__</code> method gets called. If an exception is raised within the <code class="language-plaintext highlighter-rouge">__init__</code> or <code class="language-plaintext highlighter-rouge">__enter__</code> methods, the code within the <code class="language-plaintext highlighter-rouge">with</code> statement block will not get executed and the <code class="language-plaintext highlighter-rouge">__exit__</code> method will never get called. Once the <code class="language-plaintext highlighter-rouge">with</code> statement block is entered though, the <code class="language-plaintext highlighter-rouge">__exit__</code> method is always called and will handle any exceptions.</p>

<p>Let’s take a look at a trivial example:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">DummyContextManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__init__'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__enter__'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__exit__'</span><span class="p">)</span>

        <span class="c1"># Exception description
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'type, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'value, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_value</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'traceback, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_traceback</span><span class="p">))</span>


<span class="k">with</span> <span class="n">DummyContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'within code block'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span></code></pre></figure>

<p>will give the following output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">__init__</span>
<span class="n">__enter__</span>
<span class="n">within</span> <span class="n">code</span> <span class="n">block</span>
<span class="n">__exit__</span>
<span class="nb">type</span><span class="p">,</span> <span class="bp">None</span>
<span class="n">value</span><span class="p">,</span> <span class="bp">None</span>
<span class="n">traceback</span><span class="p">,</span> <span class="bp">None</span>
<span class="n">done</span></code></pre></figure>

<p>Great! We can clearly see the context flow with these <code class="language-plaintext highlighter-rouge">print</code> statements. From the top, the <code class="language-plaintext highlighter-rouge">__init__</code> method is called followed by the <code class="language-plaintext highlighter-rouge">__enter__</code> method. After this, the context enters the <code class="language-plaintext highlighter-rouge">with</code> statement block. After the context leaves the <code class="language-plaintext highlighter-rouge">with</code> statement block, it returns to the context manager and the <code class="language-plaintext highlighter-rouge">__exit__</code> method is called. If no exceptions occured when the context exited, then the <code class="language-plaintext highlighter-rouge">exc_type</code>, <code class="language-plaintext highlighter-rouge">exc_value</code>, <code class="language-plaintext highlighter-rouge">exc_traceback</code> arguments of the <code class="language-plaintext highlighter-rouge">__exit__</code> method are <code class="language-plaintext highlighter-rouge">None</code>. Finally, the context continues to the statement immediately after the <code class="language-plaintext highlighter-rouge">with</code> statement.</p>

<p>Let’s try to raise an exception within the <code class="language-plaintext highlighter-rouge">__enter__</code> method to demonstrate that the code within the <code class="language-plaintext highlighter-rouge">with</code> statement block and the <code class="language-plaintext highlighter-rouge">__exit__</code> method will not get executed:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">DummyContextManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__init__'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__enter__'</span><span class="p">)</span>

        <span class="c1"># this will raise an exception
</span>        <span class="n">quotient</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__exit__'</span><span class="p">)</span>

        <span class="c1"># Exception description
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'type, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'value, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_value</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'traceback, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_traceback</span><span class="p">))</span>


<span class="k">with</span> <span class="n">DummyContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'within code block'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span></code></pre></figure>

<p>And here is the output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">__init__</span>
<span class="n">__enter__</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s">"contextmanagers.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">19</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="k">with</span> <span class="n">DummyContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
  <span class="n">File</span> <span class="s">"contextmanagers.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">9</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__enter__</span>
    <span class="n">quotient</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
<span class="nb">ZeroDivisionError</span><span class="p">:</span> <span class="n">division</span> <span class="n">by</span> <span class="n">zero</span></code></pre></figure>

<p>As you can see, the exception was raised from within the <code class="language-plaintext highlighter-rouge">__enter__</code> method, and our print statement within the <code class="language-plaintext highlighter-rouge">with</code> statement block never got called as well as the <code class="language-plaintext highlighter-rouge">__exit__</code> method and also the print statement outside the <code class="language-plaintext highlighter-rouge">with</code> statement block.</p>

<p>Now, let’s modify this example in order to let our <code class="language-plaintext highlighter-rouge">__exit__</code> method handle any exceptions thrown. We’ll move our bad division code inside the <code class="language-plaintext highlighter-rouge">with</code> statement block:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">DummyContextManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__init__'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__enter__'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__exit__'</span><span class="p">)</span>

        <span class="c1"># Exception description
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'type, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_type</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'value, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_value</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'traceback, {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">exc_traceback</span><span class="p">))</span>

        <span class="c1"># Custom exception handling
</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc_value</span><span class="p">,</span> <span class="nb">ZeroDivisionError</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Sorry, bad at math'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">print</span><span class="p">(</span><span class="s">'Sorry for the exception!'</span><span class="p">)</span>

        <span class="c1"># Surpress exception
</span>        <span class="k">return</span> <span class="bp">True</span>


<span class="k">with</span> <span class="n">DummyContextManager</span><span class="p">()</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'within code block'</span><span class="p">)</span>

    <span class="c1"># this will raise an exception
</span>    <span class="n">quotient</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'still here'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span></code></pre></figure>

<p>Before we see the output, let’s break down what’s going on here. We moved our bad division code inside with <code class="language-plaintext highlighter-rouge">with</code> statement block, and we added an additional print statement immediately after within the same block.</p>

<p>Going up to our <code class="language-plaintext highlighter-rouge">DummyContextManager</code> class, everything is the same except for the <code class="language-plaintext highlighter-rouge">__exit__</code> method. First, we print the values of <code class="language-plaintext highlighter-rouge">exc_type</code>, <code class="language-plaintext highlighter-rouge">exc_value</code> and <code class="language-plaintext highlighter-rouge">exc_traceback</code> like we’ve done with the previous examples.</p>

<p>Then, we check if the <code class="language-plaintext highlighter-rouge">exc_value</code> parameter is an instance of the <code class="language-plaintext highlighter-rouge">ZeroDivisionError</code> exception class. Note that the <code class="language-plaintext highlighter-rouge">exc_type</code> parameter is the exception class itself (whatever it may be if an exception occurs), and <code class="language-plaintext highlighter-rouge">exc_value</code> is the instance of the exception class. So basically, we’re just printing out some custom message based on what exception occurs. Finally, we return <code class="language-plaintext highlighter-rouge">True</code> to surpress the exception and allow our program to continue.</p>

<p>Now, let’s see the output of this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">__init__</span>
<span class="n">__enter__</span>
<span class="n">within</span> <span class="n">code</span> <span class="n">block</span>
<span class="n">__exit__</span>
<span class="nb">type</span><span class="p">,</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ZeroDivisionError</span><span class="o">&gt;</span>
<span class="n">value</span><span class="p">,</span> <span class="n">division</span> <span class="n">by</span> <span class="n">zero</span>
<span class="n">traceback</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">traceback</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x101d59a08</span><span class="o">&gt;</span>
<span class="n">Sorry</span><span class="p">,</span> <span class="n">bad</span> <span class="n">at</span> <span class="n">math</span>
<span class="n">done</span></code></pre></figure>

<p>Interesting! This output should have been expected. Our exception has been caught, and due to our custom exception handling, our apologetic print statement is printed out.</p>

<p>Also notice that our <code class="language-plaintext highlighter-rouge">still here</code> print statement never got printed, because the context left the <code class="language-plaintext highlighter-rouge">with</code> statement block as soon as the exception occured.</p>

<h3 id="using-contextlibcontextmanager">Using contextlib.contextmanager</h3>

<p>Defining classes with <code class="language-plaintext highlighter-rouge">__enter__</code> and <code class="language-plaintext highlighter-rouge">__exit__</code> methods is not the only way of writing context managers.</p>

<p>We can use the <code class="language-plaintext highlighter-rouge">contextlib.contextmanager</code> decorator to define a generator based function that will work with the <code class="language-plaintext highlighter-rouge">with</code> statement. To do this, we create a function the <code class="language-plaintext highlighter-rouge">@contextmanager</code> decorator and call <code class="language-plaintext highlighter-rouge">yield</code> once. Calling <code class="language-plaintext highlighter-rouge">yield</code> means that the code within the decorated function suspends while it “yields” the resource to the user and is resumed after the <code class="language-plaintext highlighter-rouge">yield</code> occurs. You can think of it like everything before the <code class="language-plaintext highlighter-rouge">yield</code> is the <code class="language-plaintext highlighter-rouge">__enter__</code> method in class-based context managers, and everything after the <code class="language-plaintext highlighter-rouge">yield</code> is like the <code class="language-plaintext highlighter-rouge">__exit__</code> method.</p>

<p>Let’s recreate our dummy context manager example using the <code class="language-plaintext highlighter-rouge">@contextmanager</code> decorator:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">dummy_context_manager</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Enter'</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Exit'</span><span class="p">)</span>


<span class="k">with</span> <span class="n">dummy_context_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'within code block'</span><span class="p">)</span></code></pre></figure>

<p>and we get the expected output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Enter</span>
<span class="n">within</span> <span class="n">code</span> <span class="n">block</span>
<span class="n">Exit</span></code></pre></figure>

<p>We can also use <code class="language-plaintext highlighter-rouge">try...except...finally</code> blocks to handle exceptions. According to the Python <a href="https://docs.python.org/3/library/contextlib.html" target="_blank">docs</a>, any unhandled exceptions in the <code class="language-plaintext highlighter-rouge">with</code> statement block are reraised when the generator resumes after the <code class="language-plaintext highlighter-rouge">yield</code> statement. So we can use <code class="language-plaintext highlighter-rouge">try...except...finally</code> to handle any exceptions that come up and handle any clean up.</p>

<p>Take this example:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">dummy_context_manager</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Enter'</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Some exception occured!'</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Exit'</span><span class="p">)</span>


<span class="k">with</span> <span class="n">dummy_context_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'within code block'</span><span class="p">)</span>

    <span class="c1"># this will raise an exception
</span>    <span class="n">quotient</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">'still here'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'done'</span><span class="p">)</span></code></pre></figure>

<p>which gives the following output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Enter</span>
<span class="n">within</span> <span class="n">code</span> <span class="n">block</span>
<span class="n">Some</span> <span class="n">exception</span> <span class="n">occured</span><span class="err">!</span>
<span class="n">Exit</span>
<span class="n">done</span></code></pre></figure>

<p>Our exception was nicely handled by the <code class="language-plaintext highlighter-rouge">try...except...finally</code> block. From the top, the generator yielded, then the code in the <code class="language-plaintext highlighter-rouge">with</code> statement block began executing. The exception from our bad math occured and was reraised inside the generator in the <code class="language-plaintext highlighter-rouge">except</code> block. This is where the generator <em>resumes</em>. After the <code class="language-plaintext highlighter-rouge">except</code> block handles the exception, the <code class="language-plaintext highlighter-rouge">finally</code> block is executed. Then, the execution continues with the statement following the <code class="language-plaintext highlighter-rouge">with</code> statement because our print statement after the bad math code within the <code class="language-plaintext highlighter-rouge">with</code> statement never gets called.</p>

<p>For another example, lets implement a file handler like the <code class="language-plaintext highlighter-rouge">open</code> function using the <code class="language-plaintext highlighter-rouge">@contextmanager</code> decorator:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">file_manager</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">open_file</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Some exception occured!'</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">open_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">with</span> <span class="n">file_manager</span><span class="p">(</span><span class="s">'foo.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">'Hello, World!'</span><span class="p">)</span></code></pre></figure>

<h3 id="context-manager-example---timer">Context Manager Example - Timer</h3>

<p>For our final example, we will implement a context manager that measures the execution of a code block with both a class and the decorator method. For this, we will use the <code class="language-plaintext highlighter-rouge">time.time</code> function.</p>

<p>First up, the class-based context manager:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Timer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Start timer...'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Stop timer...'</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">start</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Total time: {:.3f} seconds'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>


<span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></figure>

<p>and we have our output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Start</span> <span class="n">timer</span><span class="p">...</span>
<span class="n">Stop</span> <span class="n">timer</span><span class="p">...</span>
<span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">5.003</span> <span class="n">seconds</span></code></pre></figure>

<p>Next up, the generator context manager:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">timer</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Start timer...'</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Stop timer...'</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Total time: {:.3f} seconds'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">total</span><span class="p">))</span>


<span class="k">with</span> <span class="n">timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></figure>

<p>with the following output:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Start</span> <span class="n">timer</span><span class="p">...</span>
<span class="n">Stop</span> <span class="n">timer</span><span class="p">...</span>
<span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">5.001</span> <span class="n">seconds</span></code></pre></figure>

<p>Both approaches behave the same. Ultimately, its up to you depending on which approach you’re more comfortable with!</p>

<hr />
<p>Context managers can be really handy when it comes to manipulating the control flow of a particular resource in your code.
Even though the <code class="language-plaintext highlighter-rouge">open</code> function context manager is probably the most popular example, other useful context managers have been added to the Standard Library for example, <code class="language-plaintext highlighter-rouge">threading.Lock</code> objects. You can always come up with your own context managers too, when it makes sense to use them.</p>

<p>By now, I hope these examples have illustrated what context managers are and just how maintainable they can make your code! Enjoy messing around with some of these examples and happy coding! 😄</p>

  <!-- <br><br> -->
  <!-- 
    
      
        <small><em>Post by: Sangeeta Jadoonanan </em></small>
      
    
   -->
</article>

<div class="author-footer-container">
    <hr>
    <div class="author-footer">
    
      <img alt="sangeeta.io" src="/images/sangeeta_profile_pic.jpeg">
    
    <p>
        <strong>Sangeeta Jadoonanan</strong>'s personal blog.
        All thoughts and opinions are solely mine, please do your own googling and only copy paste from highly upvoted StackOverflow answers 😏
    </p>
</div>
</div>





<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-sangeeta-io'; // Required - Replace '<example>' with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


	  <script>
	    $("article").fitVids();
	    $('article p').each(function(i){
				if (($(this).find('img').length) && (!$.trim($(this).text()).length))  {
					$(this).addClass('img-only');
				}
				if ($.trim($(this).text()).length - $.trim($(this).find('small').text()).length == 0 && ($(this).find('img').length)){
					$(this).addClass('img-only-source');
				}
	  	});
	  </script>
	</div>
	<footer>
  <div class="inner">
    <p>
      <a class="fa fa-twitter" href="http://twitter.com/sjbitcode" target="_blank"></a>
      
      
      
      
      
      
      
      
      <a class="fa fa-linkedin" href="http://linkedin.com/in/sjbitcode" target="_blank"></a>
      <a class="fa fa-github" href="http://github.com/sjbitcode" target="_blank"></a>
      
      
      
      
      
      
      
      <br>
      Sangeeta Jadoonanan &copy; <script>new Date().getFullYear()&&document.write(new Date().getFullYear());</script>  • <a href="https://github.com/stijnvc/holo-alfa" target="_blank">Holo Alfa</a> theme ❤️
    </p>
  </div>
</footer>

</body>
</html>
